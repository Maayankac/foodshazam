<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>FoodShazma - ×ª×•×¦××•×ª × ×™×ª×•×—</title>
  <link rel="stylesheet" href="foodshazam-information.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
  <div class="container">
    <h2>×ª×•×¦××•×ª × ×™×ª×•×— ×”×× ×”</h2>

    <div class="image-preview">
      <img id="scanned-image" src="" style="max-width: 200px; border-radius: 8px;" alt="×ª××•× ×” ××”×¡×¨×™×§×”" />
    </div>

    <h3>××¨×›×™×‘×™× ×©×–×•×”×•:</h3>
    <ul id="ingredients-list"></ul>

    <div id="calories-summary">
      <p><strong>×¡×”"×› ×§×œ×•×¨×™×•×ª ×‘×× ×”:</strong> <span id="total-calories">0</span> ×§×§"×œ</p>
    </div>

    <div id="allergy-warning" class="hidden">
      <h3>âš ï¸ ××œ×¨×’× ×™× ×©× ××¦××•:</h3>
      <ul id="allergens-list"></ul>
    </div>
    <div id="no-allergens" class="hidden">
      <p>âœ… ×œ× × ××¦××• ××œ×¨×’× ×™× ×ª×•×××™× ×œ×¨×©×™××ª ×”××œ×¨×’×™×•×ª ×©×œ×š.</p>
    </div>

    <a href="foodshazam-scan.html" class="back-button">×—×–×¨×” ×œ×¡×¨×™×§×”</a>
  </div>

  <nav class="bottom-nav">
    <a href="foodshazma-home.html">
      <img src="home.png" alt="×‘×™×ª">
      <span>×“×£ ×”×‘×™×ª</span>
    </a>
    <a href="foodshazam-scan.html">
      <img src="scan.png" alt="×¡×¨×™×§×”">
      <span>×¡×¨×™×§×”</span>
    </a>
    <a href="foodshazam-history.html" class="active">
      <img src="history.png" alt="×”×™×¡×˜×•×¨×™×”">
      <span>×”×™×¡×˜×•×¨×™×”</span>
    </a>
    <a href="foodshazam-signup.html">
      <img src="signup.png" alt="×¤×¨×•×¤×™×œ">
      <span>×”×¨×©××”/×¤×¨×•×¤×™×œ</span>
    </a>
  </nav>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    // ××™×œ×•×Ÿ ×¡×™× ×•× ×™××™× ×œ××œ×¨×’×™×•×ª
    const allergenSynonyms = {
      "×©×•××©×•×": ["×©×•××©×•×", "sesame", "sesame seeds"],
      "×‘×•×˜× ×™×": ["×‘×•×˜× ×™×", "peanut", "peanuts", "peanut sauce"],
      "×—×œ×‘": ["×—×œ×‘", "milk", "dairy", "lactose"],
      "×¡×•×™×”": ["×¡×•×™×”", "soy", "soybeans", "soy sauce"],
      "×‘×™×¦×™×": ["×‘×™×¦×™×", "eggs", "egg"],
      "×’×œ×•×˜×Ÿ": ["×’×œ×•×˜×Ÿ", "gluten", "wheat"],
      "×©×§×“×™×": ["×©×§×“×™×", "almonds", "almond"],
      "××’×•×–×™×": ["××’×•×–×™×", "nuts", "walnuts", "pecan", "cashew", "hazelnut"],
      "×“×’×™×": ["×“×’×™×", "fish", "salmon", "tuna"],
      "×¤×™×¨×•×ª ×™×": ["×¤×™×¨×•×ª ×™×", "seafood", "shrimp", "crab", "shellfish"]
    };

    document.addEventListener('DOMContentLoaded', async () => {
      const supabaseUrl = 'https://kimdnostypcecnboxtyf.supabase.co';
      const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtpbWRub3N0eXBjZWNuYm94dHlmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU4MjMwODQsImV4cCI6MjA2MTM5OTA4NH0.CwJTYsEcmSPmvqTm9Jvt3sRzPcGuO9rZbCp2viZVyP4';
      const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

      const { data: sessionData } = await supabase.auth.getSession();
      const user = sessionData?.session?.user;

      if (!user) {
        console.warn('ğŸŸ  ××™×Ÿ ××©×ª××© ××—×•×‘×¨');
        return;
      }

      const { data: userData } = await supabase
        .from('users')
        .select('allergies')
        .eq('id', user.id)
        .single();

      const userAllergiesRaw = userData?.allergies || [];
      const userAllergies = Array.isArray(userAllergiesRaw)
        ? userAllergiesRaw
        : userAllergiesRaw.split(',').map(a => a.trim().toLowerCase());

      // ×‘× ×™×™×ª ××™×œ×•×Ÿ ×”×¤×•×š (×¡×™× ×•× ×™××™× -> ××œ×¨×’×™×” ×¢×™×§×¨×™×ª)
      const reverseSynonymsMap = {};
      Object.entries(allergenSynonyms).forEach(([main, synonyms]) => {
        synonyms.forEach(s => reverseSynonymsMap[s.toLowerCase()] = main);
      });

      // × ×¨××•×œ ×”××œ×¨×’×™×•×ª ×œ××¤×ª×—×•×ª ×”×¢×‘×¨×™×™×
      const normalizedAllergies = userAllergies.map(a => reverseSynonymsMap[a.toLowerCase()] || a);

      // ×‘× ×™×™×ª ×›×œ ×”×¡×™× ×•× ×™××™× ×œ×‘×“×™×§×”
      const allergySynonyms = normalizedAllergies.flatMap(allergy =>
        allergenSynonyms[allergy] || [allergy]
      ).map(a => a.toLowerCase());

      // ğŸ” DEBUG
      console.log("ğŸ“¦ ×¨×©×™××ª ××œ×¨×’×™×•×ª ×”××©×ª××©:", userAllergies);
      console.log("ğŸ§© ×›×œ ×”×¡×™× ×•× ×™××™× ×œ×‘×“×™×§×”:", allergySynonyms);

      const ingredients = JSON.parse(sessionStorage.getItem('ingredients') || '[]');
      const allergensFromSession = JSON.parse(sessionStorage.getItem('allergens') || '[]');
      const allergensInScan = [...ingredients.map(i => i.name), ...allergensFromSession];

      console.log("ğŸ§ª ×¨×©×™××ª ××¨×›×™×‘×™× ×©× ×¡×¨×§×•:", allergensInScan);

      const imageUrl = sessionStorage.getItem('imageUrl') || '';
      const totalCalories = +sessionStorage.getItem('totalCalories') || 0;

      document.getElementById('scanned-image').src = imageUrl || '';
      document.getElementById('total-calories').textContent = totalCalories;

ingredientsListEl.innerHTML = ingredients.length > 0
  ? ingredients.map(item => {
      const name = item?.name || '××¨×›×™×‘ ×œ× ×™×“×•×¢';
      const calories = item?.calories ?? '?';
      return `<li>${name}: ${calories} ×§×œ×•×¨×™×•×ª</li>`;
    }).join('')
  : '<li>×œ× ×–×•×”×• ××¨×›×™×‘×™×.</li>';


      const allergensListEl = document.getElementById('allergens-list');
      const allergyWarningEl = document.getElementById('allergy-warning');
      const noAllergensEl = document.getElementById('no-allergens');

const matchingAllergens = allergensInScan.filter(scannedAllergen =>
  allergySynonyms.some(syn =>
    scannedAllergen.toLowerCase().includes(syn)
  )
);



      if (matchingAllergens.length > 0) {
        allergensListEl.innerHTML = matchingAllergens.map(a => `<li style="color:red; font-weight:bold;">âš ï¸ ${a}</li>`).join('');
        allergyWarningEl.classList.remove('hidden');
        noAllergensEl.classList.add('hidden');
      } else {
        allergyWarningEl.classList.add('hidden');
        noAllergensEl.classList.remove('hidden');
      }
    });
  </script>
</body>
</html>
