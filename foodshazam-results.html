<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>FoodShazma - ×ª×•×¦××•×ª × ×™×ª×•×—</title>
  <link rel="stylesheet" href="foodshazam-information.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>
  <div class="container">
    <h2>×ª×•×¦××•×ª × ×™×ª×•×— ×”×× ×”</h2>

    <div class="image-preview">
      <img id="scanned-image" src="" style="max-width: 200px; border-radius: 8px;" alt="×ª××•× ×” ××”×¡×¨×™×§×”" />
    </div>

    <h3>××¨×›×™×‘×™× ×©×–×•×”×•:</h3>
    <ul id="ingredients-list"></ul>

    <div id="calories-summary" class="hidden">
      <p><strong>×¡×”"×› ×§×œ×•×¨×™×•×ª ×‘×× ×”:</strong> <span id="total-calories">0</span> ×§×§"×œ</p>
    </div>

    <div id="allergy-warning" class="hidden">
      <h3>âš ï¸ ××œ×¨×’× ×™× ×©× ××¦××•:</h3>
      <ul id="allergens-list"></ul>
    </div>
    <div id="no-allergens" class="hidden">
      <p>âœ… ×œ× × ××¦××• ××œ×¨×’× ×™× ×ª×•×××™× ×œ×¨×©×™××ª ×”××œ×¨×’×™×•×ª ×©×œ×š.</p>
    </div>

    <a href="foodshazam-scan.html" class="back-button">×—×–×¨×” ×œ×¡×¨×™×§×”</a>
  </div>

  <nav class="bottom-nav">
    <a href="foodshazma-home.html"><img src="home.png" alt="×‘×™×ª"><span>×“×£ ×”×‘×™×ª</span></a>
    <a href="foodshazam-scan.html"><img src="scan.png" alt="×¡×¨×™×§×”"><span>×¡×¨×™×§×”</span></a>
    <a href="foodshazam-history.html" class="active"><img src="history.png" alt="×”×™×¡×˜×•×¨×™×”"><span>×”×™×¡×˜×•×¨×™×”</span></a>
    <a href="foodshazam-signup.html"><img src="signup.png" alt="×¤×¨×•×¤×™×œ"><span>×”×¨×©××”/×¤×¨×•×¤×™×œ</span></a>
  </nav>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const supabase = window.supabase.createClient(
        'https://kimdnostypcecnboxtyf.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...' // ğŸ”’ ×”×›× ×¡ ××ª ×”××¤×ª×— ×©×œ×š ×›××Ÿ
      );

      const { data: { user } } = await supabase.auth.getUser();
      const ingredients = JSON.parse(sessionStorage.getItem('ingredients') || '[]');
      const totalCalories = +sessionStorage.getItem('totalCalories') || 0;
      const imageUrl = sessionStorage.getItem('imageUrl') || '';

      const scannedImage = document.getElementById('scanned-image');
      const ingredientsList = document.getElementById('ingredients-list');
      const totalCaloriesEl = document.getElementById('total-calories');
      const caloriesSummaryEl = document.getElementById('calories-summary');
      const allergensList = document.getElementById('allergens-list');
      const allergyWarning = document.getElementById('allergy-warning');
      const noAllergens = document.getElementById('no-allergens');

      // ×ª××•× ×”
      scannedImage.src = imageUrl || '';
      scannedImage.alt = imageUrl ? '×ª××•× ×” ××”×¡×¨×™×§×”' : '×ª××•× ×” ×œ× ×–××™× ×”';

      // ××¨×›×™×‘×™×
      ingredientsList.innerHTML = '';
      if (ingredients.length > 0) {
        ingredients.forEach(item => {
          const li = document.createElement('li');
          li.textContent = `${item.name}: ${item.calories} ×§×œ×•×¨×™×•×ª`;
          ingredientsList.appendChild(li);
        });
        caloriesSummaryEl.classList.remove('hidden');
        totalCaloriesEl.textContent = totalCalories;
      } else {
        ingredientsList.innerHTML = '<li>×œ× ×–×•×”×• ××¨×›×™×‘×™×.</li>';
      }

      // ×©×œ×™×¤×ª ××œ×¨×’×™×•×ª ××”××©×ª××©
      let userAllergies = [];
      if (user) {
        const { data: userData } = await supabase
          .from('users')
          .select('allergies')
          .eq('id', user.id)
          .maybeSingle();

        userAllergies = userData?.allergies || [];
      }

      // ×‘×“×™×§×ª ××¨×›×™×‘×™× ××•×œ ××œ×¨×’×™×•×ª
      let foundAllergens = [];
      ingredients.forEach(item => {
        if (userAllergies.some(allergy => item.name.toLowerCase().includes(allergy.toLowerCase()))) {
          foundAllergens.push(item.name);
        }
      });

      if (foundAllergens.length > 0) {
        allergyWarning.classList.remove('hidden');
        noAllergens.classList.add('hidden');
        allergensList.innerHTML = '';
        foundAllergens.forEach(a => {
          const li = document.createElement('li');
          li.textContent = 'âš ï¸ ' + a;
          li.style.color = 'red';
          li.style.fontWeight = 'bold';
          allergensList.appendChild(li);
        });
      } else {
        allergyWarning.classList.add('hidden');
        noAllergens.classList.remove('hidden');
      }
    });
  </script>
</body>
</html>
