<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>FoodShazma - תוצאות ניתוח</title>
  <link rel="stylesheet" href="foodshazam-information.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>
  <div class="container">
    <h2>תוצאות ניתוח המנה</h2>

    <!-- תמונה -->
    <div class="image-preview">
      <img id="scanned-image" src="" style="max-width: 200px; border-radius: 8px;" alt="תמונה מהסריקה" />
    </div>

    <!-- מרכיבים -->
    <h3>מרכיבים שזוהו:</h3>
    <ul id="ingredients-list"></ul>

    <!-- סיכום קלוריות -->
    <div id="calories-summary" class="hidden">
      <p><strong>סה"כ קלוריות במנה:</strong> <span id="total-calories">0</span> קק"ל</p>
    </div>

    <!-- אלרגנים -->
    <div id="allergy-warning" class="hidden">
      <h3>⚠️ אלרגנים שנמצאו:</h3>
      <ul id="allergens-list"></ul>
    </div>
    <div id="no-allergens" class="hidden">
      <p>✅ לא נמצאו אלרגנים תואמים לרשימת האלרגיות שלך.</p>
    </div>

    <a href="foodshazam-scan.html" class="back-button">חזרה לסריקה</a>
  </div>

  <nav class="bottom-nav">
    <a href="foodshazma-home.html">
      <img src="home.png" alt="בית">
      <span>דף הבית</span>
    </a>
    <a href="foodshazam-scan.html">
      <img src="scan.png" alt="סריקה">
      <span>סריקה</span>
    </a>
    <a href="foodshazam-history.html" class="active">
      <img src="history.png" alt="היסטוריה">
      <span>היסטוריה</span>
    </a>
    <a href="foodshazam-signup.html">
      <img src="signup.png" alt="פרופיל">
      <span>הרשמה/פרופיל</span>
    </a>
  </nav>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const supabase = window.supabase.createClient('https://kimdnostypcecnboxtyf.supabase.co', 'eyJhbGciOiJI...'); // 🔒 החלף במפתח שלך
      const { data: sessionData } = await supabase.auth.getSession();
      const userId = sessionData?.session?.user?.id;

      const ingredients = JSON.parse(sessionStorage.getItem('ingredients') || '[]');
      const detectedAllergens = JSON.parse(sessionStorage.getItem('allergens') || '[]');
      const imageUrl = sessionStorage.getItem('imageUrl') || '';
      const totalCalories = +sessionStorage.getItem('totalCalories') || 0;

      const scannedImage = document.getElementById('scanned-image');
      const ingredientsListEl = document.getElementById('ingredients-list');
      const totalCaloriesEl = document.getElementById('total-calories');
      const caloriesSummaryEl = document.getElementById('calories-summary');
      const allergensListEl = document.getElementById('allergens-list');
      const allergyWarningEl = document.getElementById('allergy-warning');
      const noAllergensEl = document.getElementById('no-allergens');

      // תמונה
      scannedImage.src = imageUrl || '';
      scannedImage.alt = imageUrl ? 'תמונה מהסריקה' : 'תמונה לא זמינה';

      // הצגת מרכיבים וקלוריות
      if (ingredients.length > 0) {
        ingredients.forEach(item => {
          const li = document.createElement('li');
          li.textContent = `${item.name || item}: ${item.calories || 0} קלוריות`;
          ingredientsListEl.appendChild(li);
        });
        caloriesSummaryEl.classList.remove('hidden');
        totalCaloriesEl.textContent = totalCalories;
      } else {
        ingredientsListEl.innerHTML = '<li>לא זוהו מרכיבים.</li>';
      }

      // קבלת אלרגיות המשתמש מה-DB
      const { data: userData, error } = await supabase.from('users').select('allergies').eq('id', userId).single();
      const userAllergies = (userData?.allergies || []).map(a => a.toLowerCase());

      // בדיקה אם יש התאמה לאלרגיות
      const matchedAllergens = detectedAllergens.filter(a => userAllergies.includes(a.toLowerCase()));

      if (matchedAllergens.length > 0) {
        allergyWarningEl.classList.remove('hidden');
        noAllergensEl.classList.add('hidden');
        allergensListEl.innerHTML = '';
        matchedAllergens.forEach(a => {
          const li = document.createElement('li');
          li.textContent = '⚠️ ' + a;
          li.style.color = 'red';
          li.style.fontWeight = 'bold';
          allergensListEl.appendChild(li);
        });
      } else {
        allergyWarningEl.classList.add('hidden');
        noAllergensEl.classList.remove('hidden');
      }
    });
  </script>
</body>
</html>
