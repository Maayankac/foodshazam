<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>FoodShazma - תוצאות ניתוח</title>
  <link rel="stylesheet" href="foodshazam-information.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
  <div class="container">
    <h2>תוצאות ניתוח המנה</h2>

    <div class="image-preview">
      <img id="scanned-image" src="" style="max-width: 200px; border-radius: 8px;" alt="תמונה מהסריקה" />
    </div>

    <h3>מרכיבים שזוהו:</h3>
    <ul id="ingredients-list"></ul>

    <div id="calories-summary">
      <p><strong>סה"כ קלוריות במנה:</strong> <span id="total-calories">0</span> קק"ל</p>
    </div>

    <div id="allergy-warning" class="hidden">
      <h3>⚠️ אלרגנים שנמצאו:</h3>
      <ul id="allergens-list"></ul>
    </div>
    <div id="no-allergens" class="hidden">
      <p>✅ לא נמצאו אלרגנים תואמים לרשימת האלרגיות שלך.</p>
    </div>

    <a href="foodshazam-scan.html" class="back-button">חזרה לסריקה</a>
  </div>

  <nav class="bottom-nav">
    <a href="foodshazma-home.html">
      <img src="home.png" alt="בית">
      <span>דף הבית</span>
    </a>
    <a href="foodshazam-scan.html">
      <img src="scan.png" alt="סריקה">
      <span>סריקה</span>
    </a>
    <a href="foodshazam-history.html" class="active">
      <img src="history.png" alt="היסטוריה">
      <span>היסטוריה</span>
    </a>
    <a href="foodshazam-signup.html">
      <img src="signup.png" alt="פרופיל">
      <span>הרשמה/פרופיל</span>
    </a>
  </nav>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    // מילון סינונימים לאלרגיות
    const allergenSynonyms = {
      "שומשום": ["שומשום", "sesame", "sesame seeds"],
      "בוטנים": ["בוטנים", "peanut", "peanuts", "peanut sauce"],
      "חלב": ["חלב", "milk", "dairy", "lactose"],
      "סויה": ["סויה", "soy", "soybeans", "soy sauce"],
      "ביצים": ["ביצים", "eggs", "egg"],
      "גלוטן": ["גלוטן", "gluten", "wheat"],
      "שקדים": ["שקדים", "almonds", "almond"],
      "אגוזים": ["אגוזים", "nuts", "walnuts", "pecan", "cashew", "hazelnut"],
      "דגים": ["דגים", "fish", "salmon", "tuna"],
      "פירות ים": ["פירות ים", "seafood", "shrimp", "crab", "shellfish"]
    };

    document.addEventListener('DOMContentLoaded', async () => {
      const supabaseUrl = 'https://kimdnostypcecnboxtyf.supabase.co';
      const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtpbWRub3N0eXBjZWNuYm94dHlmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU4MjMwODQsImV4cCI6MjA2MTM5OTA4NH0.CwJTYsEcmSPmvqTm9Jvt3sRzPcGuO9rZbCp2viZVyP4';
      const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

      const { data: sessionData } = await supabase.auth.getSession();
      const user = sessionData?.session?.user;

      if (!user) {
        console.warn('🟠 אין משתמש מחובר');
        return;
      }

      const { data: userData } = await supabase
        .from('users')
        .select('allergies')
        .eq('id', user.id)
        .single();

      const userAllergiesRaw = userData?.allergies || [];
      const userAllergies = Array.isArray(userAllergiesRaw)
        ? userAllergiesRaw
        : userAllergiesRaw.split(',').map(a => a.trim().toLowerCase());

      // בניית מילון הפוך (סינונימים -> אלרגיה עיקרית)
      const reverseSynonymsMap = {};
      Object.entries(allergenSynonyms).forEach(([main, synonyms]) => {
        synonyms.forEach(s => reverseSynonymsMap[s.toLowerCase()] = main);
      });

      // נרמול האלרגיות למפתחות העבריים
      const normalizedAllergies = userAllergies.map(a => reverseSynonymsMap[a.toLowerCase()] || a);

      // בניית כל הסינונימים לבדיקה
      const allergySynonyms = normalizedAllergies.flatMap(allergy =>
        allergenSynonyms[allergy] || [allergy]
      ).map(a => a.toLowerCase());

      // 🔍 DEBUG
      console.log("📦 רשימת אלרגיות המשתמש:", userAllergies);
      console.log("🧩 כל הסינונימים לבדיקה:", allergySynonyms);

      const ingredients = JSON.parse(sessionStorage.getItem('ingredients') || '[]');
      const allergensFromSession = JSON.parse(sessionStorage.getItem('allergens') || '[]');
      const allergensInScan = [...ingredients.map(i => i.name), ...allergensFromSession];

      console.log("🧪 רשימת מרכיבים שנסרקו:", allergensInScan);

      const imageUrl = sessionStorage.getItem('imageUrl') || '';
      const totalCalories = +sessionStorage.getItem('totalCalories') || 0;

      document.getElementById('scanned-image').src = imageUrl || '';
      document.getElementById('total-calories').textContent = totalCalories;

      const ingredientsListEl = document.getElementById('ingredients-list');
      ingredientsListEl.innerHTML = ingredients.length > 0
        ? ingredients.map(item => `<li>${item.name}: ${item.calories} קלוריות</li>`).join('')
        : '<li>לא זוהו מרכיבים.</li>';

      const allergensListEl = document.getElementById('allergens-list');
      const allergyWarningEl = document.getElementById('allergy-warning');
      const noAllergensEl = document.getElementById('no-allergens');

const matchingAllergens = allergensInScan.filter(scannedAllergen =>
  allergySynonyms.some(syn =>
    scannedAllergen.toLowerCase().includes(syn)
  )
);



      if (matchingAllergens.length > 0) {
        allergensListEl.innerHTML = matchingAllergens.map(a => `<li style="color:red; font-weight:bold;">⚠️ ${a}</li>`).join('');
        allergyWarningEl.classList.remove('hidden');
        noAllergensEl.classList.add('hidden');
      } else {
        allergyWarningEl.classList.add('hidden');
        noAllergensEl.classList.remove('hidden');
      }
    });
  </script>
</body>
</html>
