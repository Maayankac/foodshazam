<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>FoodShazma - תוצאות ניתוח</title>
  <link rel="stylesheet" href="foodshazam-information.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
  <div class="container">
    <h2>תוצאות ניתוח המנה</h2>

    <div class="image-preview">
      <img id="scanned-image" src="" style="max-width: 200px; border-radius: 8px;" alt="תמונה מהסריקה" />
    </div>

    <h3>מרכיבים שזוהו:</h3>
    <ul id="ingredients-list"></ul>

    <div id="calories-summary">
      <p><strong>סה"כ קלוריות במנה:</strong> <span id="total-calories">0</span> קק"ל</p>
    </div>

    <div id="allergy-warning" class="hidden">
      <h3>⚠️ אלרגנים שנמצאו:</h3>
      <ul id="allergens-list"></ul>
    </div>
    <div id="no-allergens" class="hidden">
      <p>✅ לא נמצאו אלרגנים תואמים לרשימת האלרגיות שלך.</p>
    </div>

    <a href="foodshazam-scan.html" class="back-button">חזרה לסריקה</a>
  </div>

  <nav class="bottom-nav">
    <a href="foodshazma-home.html">
      <img src="home.png" alt="בית">
      <span>דף הבית</span>
    </a>
    <a href="foodshazam-scan.html">
      <img src="scan.png" alt="סריקה">
      <span>סריקה</span>
    </a>
    <a href="foodshazam-history.html" class="active">
      <img src="history.png" alt="היסטוריה">
      <span>היסטוריה</span>
    </a>
    <a href="foodshazam-signup.html">
      <img src="signup.png" alt="פרופיל">
      <span>הרשמה/פרופיל</span>
    </a>
  </nav>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const supabaseUrl = 'https://kimdnostypcecnboxtyf.supabase.co';
      const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtpbWRub3N0eXBjZWNuYm94dHlmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU4MjMwODQsImV4cCI6MjA2MTM5OTA4NH0.CwJTYsEcmSPmvqTm9Jvt3sRzPcGuO9rZbCp2viZVyP4'; // 🔒 החלף במפתח שלך
      const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

      const { data: sessionData, error } = await supabase.auth.getSession();
      const user = sessionData?.session?.user;

      if (!user) {
        console.warn('🟠 אין משתמש מחובר');
        return;
      }

      const { data: userData, error: userError } = await supabase
        .from('users')
        .select('allergies')
        .eq('id', user.id)
        .single();

      const userAllergies = userData?.allergies || [];

      const ingredients = JSON.parse(sessionStorage.getItem('ingredients') || '[]');
      const allergensInScan = JSON.parse(sessionStorage.getItem('allergens') || '[]');
      const imageUrl = sessionStorage.getItem('imageUrl') || '';
      const totalCalories = +sessionStorage.getItem('totalCalories') || 0;

      const scannedImage = document.getElementById('scanned-image');
      scannedImage.src = imageUrl || '';
      scannedImage.alt = 'תמונה לא זמינה';

      const ingredientsListEl = document.getElementById('ingredients-list');
      ingredientsListEl.innerHTML = ingredients.length > 0
        ? ingredients.map(item => `<li>${item.name}: ${item.calories} קלוריות</li>`).join('')
        : '<li>לא זוהו מרכיבים.</li>';

      const totalCaloriesEl = document.getElementById('total-calories');
      totalCaloriesEl.textContent = totalCalories;

      const allergensListEl = document.getElementById('allergens-list');
      const allergyWarningEl = document.getElementById('allergy-warning');
      const noAllergensEl = document.getElementById('no-allergens');

      const matchingAllergens = allergensInScan.filter(a =>
        userAllergies.some(ua => a.toLowerCase().includes(ua.toLowerCase()))
      );

      if (matchingAllergens.length > 0) {
        allergensListEl.innerHTML = matchingAllergens.map(a => `<li style="color:red; font-weight:bold;">⚠️ ${a}</li>`).join('');
        allergyWarningEl.classList.remove('hidden');
        noAllergensEl.classList.add('hidden');
      } else {
        allergyWarningEl.classList.add('hidden');
        noAllergensEl.classList.remove('hidden');
      }
    });
  </script>
</body>
</html>
