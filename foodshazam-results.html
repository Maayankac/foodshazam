document.addEventListener('DOMContentLoaded', () => {
  const ingredients = JSON.parse(sessionStorage.getItem('ingredients') || '[]');
  const userAllergies = JSON.parse(sessionStorage.getItem('userAllergies') || '[]');
  const imageUrl = sessionStorage.getItem('imageUrl');
  const totalCalories = +sessionStorage.getItem('totalCalories') || 0;

  const scannedImage = document.getElementById('scanned-image');
  const ingredientsListEl = document.getElementById('ingredients-list');
  const totalCaloriesEl = document.getElementById('total-calories');
  const caloriesSummaryEl = document.getElementById('calories-summary');
  const allergensListEl = document.getElementById('allergens-list');
  const allergyWarningEl = document.getElementById('allergy-warning');
  const noAllergensEl = document.getElementById('no-allergens');

  if (scannedImage && imageUrl) scannedImage.src = imageUrl;
  else if (scannedImage) scannedImage.alt = 'תמונה לא זמינה';

  const allergenSynonyms = { /* כמו בקוד שלך */ };

  let detectedAllergens = [];
  ingredientsListEl.innerHTML = '';

  ingredients.forEach(item => {
    const name = item.name || item;
    const calories = item.calories || 0;
    const li = document.createElement('li');
    li.textContent = `${name}: ${calories} קלוריות`;

    const nameNorm = name.toLowerCase();
    userAllergies.forEach(userAllergy => {
      const allergyNorm = userAllergy.toLowerCase();
      const synonyms = Object.values(allergenSynonyms).find(list =>
        list.map(s => s.toLowerCase()).includes(allergyNorm)
      ) || [allergyNorm];

      if (synonyms.some(syn => nameNorm.includes(syn))) {
        li.style.color = 'red';
        li.style.fontWeight = 'bold';
        if (!detectedAllergens.includes(userAllergy)) detectedAllergens.push(userAllergy);
      }
    });

    ingredientsListEl.appendChild(li);
  });

  if (ingredients.length) {
    caloriesSummaryEl.classList.remove('hidden');
    totalCaloriesEl.textContent = totalCalories;
  }

  if (detectedAllergens.length) {
    allergyWarningEl.classList.remove('hidden');
    noAllergensEl.classList.add('hidden');
    allergensListEl.innerHTML = '';
    detectedAllergens.forEach(a => {
      const li = document.createElement('li');
      li.textContent = a;
      allergensListEl.appendChild(li);
    });
  } else {
    allergyWarningEl.classList.add('hidden');
    noAllergensEl.classList.remove('hidden');
  }
});
